#
# DISCLAIMER: THIS IS FOR DEVELOPMENT PURPOSES ONLY AND NOT SUITABLE FOR PRODUCTION.
#
# You can use this docker-compose to spin up a local stack for demo/try-out
# purposes, or to get some insight in the various components involved (e.g. to build
# your Helm charts from). Note that various environment variables are UNSAFE and merely
# specified so that you can get up and running with the least amount of friction.
services:
  openklant-redis:
    image: redis:7
    networks:
      - openklant-dev

  openklant-db:
    image: postgres:17
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust
    volumes:
      - ./docker-init-db.sql:/docker-entrypoint-initdb.d/init_db.sql
      - open-klant-db:/var/lib/postgresql/data
    networks:
      - openklant-dev

  openklant-web:
    image: maykinmedia/open-klant:latest
    environment: &web_env
      DJANGO_SETTINGS_MODULE: openklant.conf.docker
      IS_HTTPS: no
      DB_NAME: postgres
      DB_USER: postgres
      DB_HOST: openklant-db
      ALLOWED_HOSTS: '*'
      CACHE_DEFAULT: openklant-redis:6379/0
      CACHE_AXES: openklant-redis:6379/0
      SUBPATH: ${SUBPATH:-/}
      SECRET_KEY: ${SECRET_KEY:-django-insecure-f8s@b*ds4t84-q_2#c0j0506@!l2q6r5_pq5e!vm^_9c*#^66b}
      CELERY_BROKER_URL: redis://openklant-redis:6379/0
      CELERY_RESULT_BACKEND: redis://openklant-redis:6379/0
      DISABLE_2FA: true
      LOG_NOTIFICATIONS_IN_DB: ${LOG_NOTIFICATIONS_IN_DB:-yes}
      DB_CONN_MAX_AGE: "0"
      DB_POOL_ENABLED: True
      OTEL_SDK_DISABLED: True
    volumes: &web_volumes
      - media:/app/media
      - private_media:/app/private_media
    ports:
      - 8005:8000
    depends_on:
      openklant-db:
        condition: service_started
      openklant-redis:
        condition: service_started
    labels:
      client: dev
      target: test
      app: open-klant
      service: openklant-web
    networks:
      - openklant-dev

  web-init:
    image: maykinmedia/open-klant:latest
    environment:
      <<: *web_env
      RUN_SETUP_CONFIG: ${RUN_SETUP_CONFIG:-true}

    command: sh -c "/upgrade_check_version.sh &&
                    /setup_configuration.sh"
    volumes:
      - ./setup_configuration:/app/setup_configuration/
    depends_on:
      - openklant-db
      - openklant-redis
    networks:
      - openklant-dev

  celery:
    image: maykinmedia/open-klant:latest
    environment: *web_env
    command: /celery_worker.sh
    depends_on:
      openklant-web: 
        condition: service_started
    volumes: *web_volumes
    networks:
      - openklant-dev



volumes:
  open-klant-db:
  media:
  private_media:

networks:
  openklant-dev:
    name: openklant-dev